{% extends "base.html" %}

{% block title %}Admin Dashboard - CommunityHub Pro{% endblock %}

{% block extra_css %}
<style>
    .admin-header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 2rem;
    }

    .admin-title {
        font-size: 3rem;
        font-weight: 900;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #FF6B6B, #FFA500, #FFD93D, #6BCF7F, #4D96FF, #9D4EDD);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .admin-subtitle {
        font-size: 1.3rem;
        color: rgba(255, 255, 255, 0.9);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        transition: transform 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.6s ease;
    }

    .stat-card:hover::before {
        left: 100%;
    }

    .stat-card:hover {
        transform: translateY(-10px);
    }

    .stat-icon {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.8rem;
        color: white;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        color: white;
    }

    .stat-label {
        color: rgba(255, 255, 255, 0.8);
        font-size: 1rem;
        font-weight: 600;
    }

    .admin-sections {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .section-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .complaints-table {
        width: 100%;
        border-collapse: collapse;
    }

    .complaints-table th,
    .complaints-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .complaints-table th {
        color: rgba(255, 255, 255, 0.9);
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .complaints-table td {
        color: rgba(255, 255, 255, 0.8);
    }

    .complaints-table tr:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 10px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-edit {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .btn-edit:hover {
        background: rgba(59, 130, 246, 0.3);
        transform: translateY(-2px);
    }

    .btn-resolve {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .btn-resolve:hover {
        background: rgba(34, 197, 94, 0.3);
        transform: translateY(-2px);
    }

    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    .chart-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 1.5rem;
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.7);
    }

    .ai-insights {
        margin-top: 2rem;
    }

    .insight-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid;
    }

    .insight-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .insight-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .insight-title {
        font-weight: 600;
        color: white;
    }

    .insight-message {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
        line-height: 1.4;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(25px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
    }

    .close-modal {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .close-modal:hover {
        color: white;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
    }

    .form-select {
        width: 100%;
        padding: 0.75rem 1rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        color: white;
        font-family: inherit;
    }

    .form-textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        color: white;
        font-family: inherit;
        resize: vertical;
        min-height: 100px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .admin-sections {
            grid-template-columns: 1fr;
        }
        
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .admin-title {
            font-size: 2rem;
        }
        
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        
        .complaints-table {
            font-size: 0.8rem;
        }
        
        .action-buttons {
            flex-direction: column;
        }
    }
</style>

<!-- Leaflet for interactive maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2H0yGkYJv+3g2Gq6Vb2Wv3wqkH0Gk8aJv+g6YvM=" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="{{ url_for('static', path='css/admin_dashboard.css') }}">

{% endblock %}

{% block content %}
<div class="admin-header">
    <h1 class="admin-title">Admin Dashboard ðŸ‘‘</h1>
    <p class="admin-subtitle">Manage community complaints and monitor system performance</p>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #FF6B6B, #FFA500);">
            <i class="fas fa-bullhorn"></i>
        </div>
        <div class="stat-number">{{ stats.total }}</div>
        <div class="stat-label">Total Complaints</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #FFA500, #FFD93D);">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-number">{{ stats.pending }}</div>
        <div class="stat-label">Pending Review</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #6BCF7F, #4D96FF);">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-number">{{ stats.resolved }}</div>
        <div class="stat-label">Resolved</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #FF6B6B, #9D4EDD);">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-number">{{ stats.urgent }}</div>
        <div class="stat-label">Urgent Issues</div>
    </div>
</div>

<div class="admin-sections">
    <!-- Recent Complaints Table -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-list"></i>
                Recent Complaints
            </h2>
            <div class="performance-score" style="
                background: linear-gradient(135deg, #4D96FF, #9D4EDD);
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-weight: 600;
            ">
                Score: {{ analytics.performance_score }}/100
            </div>
        </div>

        <div class="table-responsive">
            <table class="complaints-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Status</th>
                        <th>Severity</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for complaint in complaints %}
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: white;">{{ complaint.title[:30] }}{% if complaint.title|length > 30 %}...{% endif %}</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">{{ complaint.user_id }}</div>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>{{ categories[complaint.category].icon }}</span>
                                <span>{{ categories[complaint.category].name }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge" style="background: {{ status_types[complaint.status].color }}20; color: {{ status_types[complaint.status].color }};">
                                {{ status_types[complaint.status].icon }}
                                {{ status_types[complaint.status].name }}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge" style="background: {{ severity_levels[complaint.severity].color }}20; color: {{ severity_levels[complaint.severity].color }};">
                                {{ severity_levels[complaint.severity].name }}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-sm btn-edit" onclick="openEditModal('{{ complaint.id }}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                {% if complaint.status != 'resolved' %}
                                <button class="btn-sm btn-resolve" onclick="resolveComplaint('{{ complaint.id }}')">
                                    <i class="fas fa-check"></i> Resolve
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Analytics & Insights -->
    <div>
        <!-- India Map & Problem List -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-map-marked-alt"></i>
                    Issues Map (India)
                </h2>
            </div>
            <div id="india-map" style="height: 420px; border-radius: 12px; overflow: hidden; margin-bottom: 1rem;"></div>
            <div style="display:flex; gap:1rem; align-items:flex-start;">
                <div style="flex:1;">
                    <div style="font-weight:700; color:white; margin-bottom:0.5rem;">Click a problem to zoom</div>
                    <div id="problem-list" style="max-height:180px; overflow:auto;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div style="width:220px; text-align:right;">
                    <div style="font-size:0.9rem; color:rgba(255,255,255,0.8);">Hotspots: {{ analytics.hotspots|length }}</div>
                    <div style="font-size:0.9rem; color:rgba(255,255,255,0.8);">Categories: {{ analytics.categories|length }}</div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-chart-line"></i>
                    Performance Metrics
                </h2>
            </div>

            <div class="charts-grid">
                <div class="chart-container" style="flex-direction:column;">
                    <canvas id="performanceChart" style="max-width:220px; max-height:220px;"></canvas>
                    <div style="margin-top:0.5rem; color: rgba(255,255,255,0.8);">Performance Score</div>
                </div>

                <div class="chart-container" style="flex-direction:column;">
                    <canvas id="categoryChart" style="width:100%; height:220px;"></canvas>
                    <div style="margin-top:0.5rem; color: rgba(255,255,255,0.8);">Complaints by Category</div>
                </div>
            </div>
        </div>

        <!-- AI Insights -->
        {% if analytics.ai_insights %}
        <div class="section-card ai-insights">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-robot"></i>
                    AI Insights
                </h2>
            </div>

            {% for insight in analytics.ai_insights %}
            <div class="insight-item" style="border-left-color: {% if insight.type == 'success' %}#6BCF7F{% elif insight.type == 'warning' %}#FFA500{% else %}#4D96FF{% endif %};">
                <div class="insight-header">
                    <div class="insight-icon" style="background: {% if insight.type == 'success' %}linear-gradient(135deg, #6BCF7F, #4D96FF){% elif insight.type == 'warning' %}linear-gradient(135deg, #FFA500, #FF6B6B){% else %}linear-gradient(135deg, #4D96FF, #9D4EDD){% endif %};">
                        {{ insight.icon }}
                    </div>
                    <div class="insight-title">{{ insight.title }}</div>
                </div>
                <div class="insight-message">{{ insight.message }}</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Complaint Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Update Complaint Status</h3>
            <button class="close-modal" onclick="closeEditModal()">&times;</button>
        </div>
        
        <form id="editComplaintForm">
            <input type="hidden" id="editComplaintId" name="complaint_id">
            
            <div class="form-group">
                <label class="form-label" for="editStatus">Status</label>
                <select id="editStatus" name="status" class="form-select" required>
                    {% for key, status in status_types.items() %}
                    <option value="{{ key }}">{{ status.icon }} {{ status.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="editAdminNotes">Admin Notes</label>
                <textarea id="editAdminNotes" name="admin_notes" class="form-textarea" 
                         placeholder="Add any notes or updates for the user..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="editAssignedTo">Assign To</label>
                <input type="text" id="editAssignedTo" name="assigned_to" class="form-select" 
                       placeholder="Enter staff name or department">
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-save"></i> Update Complaint
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentEditingComplaint = null;

    function openEditModal(complaintId) {
        currentEditingComplaint = complaintId;
        document.getElementById('editComplaintId').value = complaintId;
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        currentEditingComplaint = null;
    }

    function resolveComplaint(complaintId) {
        if (confirm('Mark this complaint as resolved?')) {
            updateComplaintStatus(complaintId, 'resolved', 'Complaint has been resolved successfully.');
        }
    }

    async function updateComplaintStatus(complaintId, status, notes = '') {
        try {
            const formData = new FormData();
            formData.append('complaint_id', complaintId);
            formData.append('status', status);
            formData.append('admin_notes', notes);

            const response = await fetch(`/admin/complaints/${complaintId}/update`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showNotification('âœ… Complaint status updated successfully!', 'success');
                // Reload the page to reflect changes
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                throw new Error(data.message || 'Failed to update complaint');
            }
        } catch (error) {
            showNotification(`âŒ ${error.message}`, 'error');
        }
    }

    // Handle edit form submission
    document.getElementById('editComplaintForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch(`/admin/complaints/${currentEditingComplaint}/update`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showNotification('âœ… Complaint updated successfully!', 'success');
                closeEditModal();
                // Reload the page to reflect changes
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                throw new Error(data.message || 'Failed to update complaint');
            }
        } catch (error) {
            showNotification(`âŒ ${error.message}`, 'error');
        }
    });

    function showNotification(message, type = 'info') {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.notification');
        existingNotifications.forEach(notification => notification.remove());

        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1.5rem 2rem;
            border-radius: 15px;
            background: ${type === 'success' ? 'linear-gradient(135deg, #6BCF7F, #4D96FF)' : 
                          type === 'error' ? 'linear-gradient(135deg, #FF6B6B, #FFA500)' : 
                          'linear-gradient(135deg, #4D96FF, #9D4EDD)'};
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: slideIn 0.5s ease;
        `;
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.animation = 'slideOut 0.5s ease forwards';
                setTimeout(() => notification.remove(), 500);
            }
        }, 4000);
    }

    // Add CSS for animations
    const styles = document.createElement('style');
    styles.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1.5rem 2rem;
            border-radius: 15px;
            z-index: 10000;
            animation: slideIn 0.5s ease;
        }
    `;
    document.head.appendChild(styles);

    // Close modal when clicking outside
    window.addEventListener('click', function(e) {
        const modal = document.getElementById('editModal');
        if (e.target === modal) {
            closeEditModal();
        }
    });

    // Real-time updates via WebSocket
    document.addEventListener('DOMContentLoaded', function() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/admin`;
        const socket = new WebSocket(wsUrl);

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.type === 'new_complaint') {
                showNotification(`ðŸ“¢ New complaint: ${data.title}`, 'info');
                // In a real app, you might want to update the table without reloading
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else if (data.type === 'status_change') {
                // Optionally handle status change notifications for admins
                showNotification(`ðŸ” Status updated: ${data.complaint_id}`, 'info');
            } else {
                // Assume this is an analytics payload and attempt to update charts
                updateAdminCharts(data);
            }
        };

        socket.onclose = function() {
            console.log('Admin WebSocket connection closed');
        };
    });

    // Chart.js: initialize admin charts and update on websocket analytics payloads
    let performanceChart = null;
    let categoryChart = null;

    function initAdminCharts(initialAnalytics) {
        // Performance doughnut
        const perfCtx = document.getElementById('performanceChart').getContext('2d');
        const perfValue = initialAnalytics.performance_score || 0;
        performanceChart = new Chart(perfCtx, {
            type: 'doughnut',
            data: {
                labels: ['Score', 'Remaining'],
                datasets: [{
                    data: [perfValue, Math.max(0, 100 - perfValue)],
                    backgroundColor: ['#4D96FF', '#2C2F36'],
                    hoverBackgroundColor: ['#6BCF7F', '#3a3d44'],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false },
                    datalabels: { display: false }
                }
            }
        });

        // Category pie
        const catCtx = document.getElementById('categoryChart').getContext('2d');
        const catData = initialAnalytics.category_pie || initialAnalytics.categories || {};
        categoryChart = new Chart(catCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(catData),
                datasets: [{
                    data: Object.values(catData),
                    backgroundColor: Object.keys(catData).map((k,i)=> {
                        // use category color mapping if available
                        const meta = {{ categories|tojson }};
                        const color = (meta[k] && meta[k].color) ? meta[k].color : ['#4D96FF','#6BCF7F','#FF6B6B','#FFA500'][i%4];
                        return color;
                    })
                }]
            },
            options: {
                plugins: { legend: { position: 'bottom', labels: { color: 'white' } } }
            }
        });
    }

    function updateAdminCharts(payload) {
        try {
            if (payload.performance_score !== undefined && performanceChart) {
                const val = payload.performance_score;
                performanceChart.data.datasets[0].data = [val, Math.max(0, 100 - val)];
                performanceChart.update();
                // update header score too
                const scoreEls = document.getElementsByClassName('performance-score');
                for (const el of scoreEls) {
                    el.textContent = `Score: ${val}/100`;
                }
            }

            const cat = payload.category_pie || payload.categories || {};
            if (categoryChart && Object.keys(cat).length) {
                categoryChart.data.labels = Object.keys(cat);
                categoryChart.data.datasets[0].data = Object.values(cat);
                categoryChart.update();
            }
        } catch (e) {
            console.error('Failed to update admin charts', e);
        }
    }

    // Initialize charts with server-rendered analytics on load
    document.addEventListener('DOMContentLoaded', function() {
        try {
            const initialAnalytics = {{ analytics | tojson }} || {};
            initAdminCharts(initialAnalytics);
        } catch (e) {
            console.error('Chart init failed', e);
        }
    });
</script>

<!-- Leaflet & MarkerCluster JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j8g+T8Xg7mXkG1fT2hFjvQG1Ykz3b4b6+5m5R3s=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Embedded complaints data for admin_dashboard JS (safe JSON) -->
<script id="complaints-data" type="application/json">{{ map_complaints | tojson | safe }}</script>

<!-- Admin dashboard static JS -->
<script src="{{ url_for('static', path='js/admin_dashboard.js') }}"></script>

{% endblock %}