{% extends "base.html" %}

{% block title %}Raise Complaint - CommunityHub Pro{% endblock %}

{% block extra_css %}
<style>
/* Typography & visuals */
:root{ 
    --base-font:18px; 
    --card-radius:24px;
    --headline-scale: 3.2;
    --subhead-scale: 1.8;
    --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.html{font-size:var(--base-font)}
html{font-size:var(--base-font)}
/* Use base dark theme; remove the bright animated page background so the base background shows through */
body{min-height:100vh;margin:0;font-family:'Space Grotesk','Inter',sans-serif;color:var(--light);background:linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, #16213E 100%)}
.floating-shapes{position:fixed;inset:0;pointer-events:none;z-index:0}
.shape{position:absolute;border-radius:50%;filter:blur(48px);opacity:.12;pointer-events:none}
.shape-1{width:360px;height:360px;background:rgba(255,255,255,0.02);top:6%;left:4%;animation:floaty 8s ease-in-out infinite}
.shape-2{width:380px;height:380px;background:rgba(255,255,255,0.02);bottom:4%;right:4%;animation:floaty 10s ease-in-out infinite}
.shape-3{width:260px;height:260px;background:rgba(255,255,255,0.02);left:18%;bottom:22%;animation:floaty 9s ease-in-out infinite}
.shape-4{width:320px;height:320px;background:rgba(255,255,255,0.02);top:28%;right:28%;animation:floaty 11s ease-in-out infinite}
@keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-18px)}100%{transform:translateY(0)}}
@keyframes gradient{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

.container{max-width:1100px;margin:3rem auto;padding:1rem;position:relative;z-index:2}
.card{
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(25px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 30px;
    padding: 2.25rem;
    box-shadow: 0 25px 50px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.3);
    max-width: 100%;
    position: relative;
    transition: transform .3s ease, box-shadow .3s ease;
}
.card::before{
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: rgba(255,255,255,0.02);
    border-radius: 32px;
    z-index: -1;
}
.card:hover{transform:translateZ(0) scale(1.01);box-shadow:0 28px 60px rgba(0,0,0,.55)}
.header{text-align:center;margin-bottom:1rem}
.header h1{font-size:2.8rem;margin:0;color:var(--light);font-weight:800}
.header p{color:rgba(255,255,255,.9);font-size:1.05rem;margin-top:.4rem}

.form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.form-group{margin-bottom:1rem}
.form-label{display:block;margin-bottom:.5rem;color:rgba(255,255,255,.95);font-weight:700;font-size:1.02rem}
input[type="text"],textarea,select{width:100%;padding:.92rem;border-radius:12px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);color:#fff;font-size:1.02rem;transition:border-color .2s ease,box-shadow .2s ease,transform .2s ease,background .2s ease}
input[type="text"]:focus,textarea:focus,select:focus{border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.04);box-shadow:0 0 0 3px rgba(255,255,255,.1);outline:none;transform:translateY(-1px)}
textarea{min-height:170px;resize:vertical}

.category-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.9rem}
.category-option{padding:1.05rem;border-radius:12px;background:rgba(255,255,255,.02);cursor:pointer;border:2px solid transparent;display:flex;align-items:center;gap:.8rem;transition:transform .22s ease,box-shadow .22s ease,background .22s ease}
.category-option:hover{transform:translateY(-6px);background:rgba(255,255,255,.035)}
.category-option.selected{box-shadow:0 18px 45px rgba(0,0,0,.45);transform:translateY(-10px);border-image:linear-gradient(90deg,#FF6B6B,#FFA500,#FFD93D,#6BCF7F,#4D96FF,#9D4EDD) 1;border-color:transparent}

.upload-area{border:2px dashed rgba(255,255,255,.06);padding:1.15rem;border-radius:12px;text-align:center;background:rgba(255,255,255,.01);cursor:pointer;transition:transform .18s ease,box-shadow .18s ease}
.upload-area.dragover{border-color:rgba(255,255,255,.32);transform:translateY(-6px);box-shadow:0 18px 36px rgba(0,0,0,.38)}
.preview img{max-width:320px;border-radius:10px;margin-top:.6rem}

.btn{display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1rem;border-radius:10px;border:none;cursor:pointer;transition:transform .2s ease,box-shadow .2s ease,background-color .2s ease,border-color .2s ease}
.btn-primary{background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); color: var(--light); font-weight:800; padding:.85rem 1.1rem; transform:translateZ(0); border: 1px solid rgba(255,255,255,0.06)}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.08);color:#fff}
.btn:active{transform:translateY(1px)}

.btn-primary{position:relative;overflow:hidden}
.btn-primary::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,rgba(255,255,255,.03),rgba(255,255,255,.06));pointer-events:none;transition:opacity .2s ease}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
.btn-primary:hover::after{opacity:.8}

.btn-ghost:hover{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.16);transform:translateY(-2px)}
.btn:focus-visible{outline:2px solid rgba(255,255,255,.3);outline-offset:2px}

.floating-shapes,.floating-shapes *,.card::before{pointer-events:none}

@media (max-width:900px){.form-row{grid-template-columns:1fr}.header h1{font-size:2.2rem}}
</style>
{% endblock %}

{% block content %}
<div class="floating-shapes" aria-hidden="true">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
    <div class="shape shape-4"></div>
</div>

<div class="container">
    <div class="card">
        <div class="header">
            <h1>Report Community Issue</h1>
            <p>Help create a better neighborhood with your feedback</p>
        </div>

        <form id="complaintForm" method="post" action="/raise-complaint" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label" for="title">Complaint Title</label>
                <input id="title" name="title" type="text" placeholder="Briefly describe the issue" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="description">Detailed Description</label>
                <textarea id="description" name="description" placeholder="Provide comprehensive details..." required></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Issue Category</label>
                    <div class="category-grid" id="categoryGrid">
                        {% for key, cat in categories.items() %}
                        <div class="category-option" data-value="{{ key }}">
                            <span style="font-size:1.2rem">{{ cat.icon }}</span>
                            <div style="flex:1;text-align:left">
                                <div style="font-weight:700">{{ cat.name }}</div>
                                <div style="font-size:0.8rem;color:rgba(255,255,255,0.7)">{{ cat.department }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="category" name="category" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="severity">Severity</label>
                    <select id="severity" name="severity">
                        {% for key, s in severity_levels.items() %}
                        <option value="{{ key }}">{{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="location">Location (address / landmark)</label>
                    <input id="location" name="location" type="text" placeholder="e.g., Main St near Park" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="state">State</label>
                    <!-- Only Tamil Nadu is supported for submissions; show as disabled for clarity and submit via hidden input -->
                    <select id="state_display" disabled style="background:rgba(255,255,255,.02);color:#ddd;border-radius:8px;padding:.75rem;border:1px solid rgba(255,255,255,.06);">
                        <option value="tamil_nadu" selected>Tamil Nadu</option>
                    </select>
                    <input type="hidden" id="state" name="state" value="tamil_nadu">
                    <div style="margin-top:0.6rem;color:rgba(255,255,255,0.8);font-size:0.95rem">
                        Complaints are accepted only for Tamil Nadu state on this CommunityHub instance.
                    </div>
                    <div style="margin-top:0.6rem;display:flex;gap:0.5rem;flex-wrap:wrap">
                        <button type="button" id="detectLocation" class="btn btn-ghost">üìç Auto-detect My Location</button>
                        <input type="hidden" id="latitude" name="latitude" value="0.0">
                        <input type="hidden" id="longitude" name="longitude" value="0.0">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Add Visual Evidence (optional)</label>
                <div id="uploadArea" class="upload-area" tabindex="0">
                    <div>Drag & drop an image here or click to browse (Max 5MB)</div>
                    <input id="complaintImage" name="image" type="file" accept="image/*" style="display:none">
                    <div class="preview" id="preview"></div>
                </div>
            </div>

            <div style="display:flex;gap:0.6rem;justify-content:flex-end;margin-top:1rem">
                <button type="submit" class="btn btn-primary">üöÄ Submit Complaint</button>
                <a href="/dashboard" class="btn btn-ghost" style="text-decoration:none">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Wire interactions: category selection, upload preview, location detection.
(function(){
        const categoryGrid = document.getElementById('categoryGrid');
        const categoryInput = document.getElementById('category');
        if(categoryGrid){
                categoryGrid.addEventListener('click', (e)=>{
                        const opt = e.target.closest('.category-option');
                        if(!opt) return;
                        categoryGrid.querySelectorAll('.category-option').forEach(o=>o.classList.remove('selected'));
                        opt.classList.add('selected');
                        categoryInput.value = opt.dataset.value;
                });
                categoryGrid.querySelectorAll('.category-option').forEach((o)=>{
                        o.setAttribute('tabindex','0');
                        o.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); o.click(); } });
                });
        }

        // Upload area
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('complaintImage');
        const preview = document.getElementById('preview');
        function showPreview(file){ preview.innerHTML = ''; if(!file) return; const img = document.createElement('img'); img.src = URL.createObjectURL(file); img.onload = ()=> URL.revokeObjectURL(img.src); preview.appendChild(img); }
        if(uploadArea){
                uploadArea.addEventListener('click', ()=> fileInput.click());
                uploadArea.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') fileInput.click(); });
                ['dragenter','dragover'].forEach(ev=>{ uploadArea.addEventListener(ev, (e)=>{ e.preventDefault(); uploadArea.classList.add('dragover'); }); });
                ['dragleave','drop'].forEach(ev=>{ uploadArea.addEventListener(ev, (e)=>{ e.preventDefault(); uploadArea.classList.remove('dragover'); }); });
                uploadArea.addEventListener('drop', (e)=>{ const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f) { fileInput.files = e.dataTransfer.files; showPreview(f); } });
        }
        if(fileInput){ fileInput.addEventListener('change', (e)=>{ const f = e.target.files[0]; if(f) showPreview(f); }); }

        // Detect location
        const detectBtn = document.getElementById('detectLocation');
        const latIn = document.getElementById('latitude');
        const lngIn = document.getElementById('longitude');
        const locationInput = document.getElementById('location');
        if(detectBtn){
                detectBtn.addEventListener('click', ()=>{
                        if(!navigator.geolocation){ alert('Geolocation not available'); return; }
                        detectBtn.disabled = true; detectBtn.textContent = 'Locating...';
                        navigator.geolocation.getCurrentPosition((pos)=>{
                                const {latitude, longitude} = pos.coords;
                                latIn.value = latitude; lngIn.value = longitude;
                                locationInput.value = locationInput.value || `Approx: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                                detectBtn.disabled = false; detectBtn.textContent = 'üìç Auto-detect My Location';
                        }, (err)=>{ detectBtn.disabled = false; detectBtn.textContent = 'üìç Auto-detect My Location'; alert('Could not detect location: '+err.message); });
                });
        }

        // Simple submit validation
        const form = document.getElementById('complaintForm');
        if(form){ form.addEventListener('submit', (e)=>{ if(!categoryInput.value){ e.preventDefault(); alert('Please select a category'); return false; } return true; }); }
})();
</script>
{% endblock %}
                if (detectLocationBtn) {
                    detectLocationBtn.addEventListener('click', this.detectLocation.bind(this));
                }

                // Input validation with visual feedback
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.addEventListener('input', this.validateField.bind(this));
                    input.addEventListener('change', this.validateField.bind(this));
                    
                    // Add focus effects
                    input.addEventListener('focus', () => {
                        input.parentElement.style.transform = 'scale(1.02)';
                    });
                    
                    input.addEventListener('blur', () => {
                        input.parentElement.style.transform = 'scale(1)';
                    });
                });

                // Image preview
                const fileInput = document.getElementById('complaintImage');
                if (fileInput) {
                    fileInput.addEventListener('change', this.handleImagePreview.bind(this));
                }
            }

            setupDragAndDrop() {
                const uploadArea = document.getElementById('imageUploadArea');
                const fileInput = document.getElementById('complaintImage');

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, () => {
                        uploadArea.classList.add('dragover');
                        uploadArea.style.animation = 'pulse 0.6s infinite';
                    }, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, () => {
                        uploadArea.classList.remove('dragover');
                        uploadArea.style.animation = '';
                    }, false);
                });

                uploadArea.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        this.handleImagePreview({ target: fileInput });
                    }
                }, false);
            }

            validateField(event) {
                const field = event.target;
                if (field.checkValidity()) {
                    field.style.borderColor = '#6BCF7F';
                    field.style.boxShadow = '0 0 30px #6BCF7F';
                    
                    // Add success particle effect
                    this.createFieldSuccessEffect(field);
                } else {
                    field.style.borderColor = '#FF6B6B';
                    field.style.boxShadow = '0 0 30px #FF6B6B';
                }
                this.updateProgress();
            }

            createFieldSuccessEffect(field) {
                const rect = field.getBoundingClientRect();
                for (let i = 0; i < 5; i++) {
                    const particle = document.createElement('div');
                    particle.style.cssText = `
                        position: fixed;
                        width: 6px;
                        height: 6px;
                        background: #6BCF7F;
                        border-radius: 50%;
                        pointer-events: none;
                        z-index: 1000;
                        left: ${rect.right}px;
                        top: ${rect.top + rect.height / 2}px;
                        animation: fieldSuccess 1s ease-out forwards;
                    `;
                    
                    document.body.appendChild(particle);
                    
                    setTimeout(() => {
                        particle.remove();
                    }, 1000);
                }
            }

            updateProgress() {
                const requiredFields = document.querySelectorAll('[required]');
                const filledFields = Array.from(requiredFields).filter(field => field.value.trim() !== '');
                const progress = (filledFields.length / requiredFields.length) * 100;
                
                const steps = document.querySelectorAll('.progress-step');
                const stepCount = Math.ceil(progress / 25);
                
                steps.forEach((step, index) => {
                    step.classList.remove('active', 'completed');
                    if (index < stepCount) {
                        step.classList.add('completed');
                        this.createStepCompletionEffect(step);
                    } else if (index === stepCount) {
                        step.classList.add('active');
                    }
                });
            }

            createStepCompletionEffect(step) {
                for (let i = 0; i < 8; i++) {
                    const particle = document.createElement('div');
                    particle.style.cssText = `
                        position: absolute;
                        width: 4px;
                        height: 4px;
                        background: #39FF14;
                        border-radius: 50%;
                        left: 50%;
                        top: 50%;
                        animation: stepParticle 1s ease-out forwards;
                    `;
                    
                    step.appendChild(particle);
                    
                    setTimeout(() => {
                        particle.remove();
                    }, 1000);
                }
            }

            handleImagePreview(event) {
                const file = event.target.files[0];
                const preview = document.getElementById('imagePreview');
                
                if (file && preview) {
                    if (!file.type.startsWith('image/')) {
                        this.showNotification('‚ùå Please select a valid image file', 'error');
                        return;
                    }

                    if (file.size > 5 * 1024 * 1024) {
                        this.showNotification('üìè Image size should be less than 5MB', 'error');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.innerHTML = `
                            <div style="text-align: center;">
                                <img src="${e.target.result}" alt="Preview" class="image-preview">
                                <button type="button" class="remove-image" onclick="removeImagePreview()">
                                    <i class="fas fa-trash"></i> üóëÔ∏è Remove Image
                                </button>
                            </div>
                        `;
                        this.showNotification('üñºÔ∏è Image uploaded successfully!', 'success');
                        this.createImageUploadEffect();
                    };
                    reader.readAsDataURL(file);
                }
            }

            createImageUploadEffect() {
                const preview = document.querySelector('.image-preview');
                if (preview) {
                    for (let i = 0; i < 12; i++) {
                        const spark = document.createElement('div');
                        spark.style.cssText = `
                            position: absolute;
                            width: 3px;
                            height: 3px;
                            background: ${this.getRandomRainbowColor()};
                            border-radius: 50%;
                            animation: sparkle 1s ease-out forwards;
                            left: 50%;
                            top: 50%;
                        `;
                        
                        preview.parentElement.appendChild(spark);
                        
                        setTimeout(() => {
                            spark.remove();
                        }, 1000);
                    }
                }
            }

            async detectLocation() {
                const locationInput = document.getElementById('location');
                const latitudeInput = document.getElementById('latitude');
                const longitudeInput = document.getElementById('longitude');
                const detectBtn = document.getElementById('detectLocation');

                if (!navigator.geolocation) {
                    this.showNotification('‚ùå Geolocation not supported', 'error');
                    return;
                }

                // Enhanced loading state
                const originalHTML = detectBtn.innerHTML;
                detectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> üåç Scanning Location...';
                detectBtn.disabled = true;
                detectBtn.style.animation = 'pulse 1s infinite';

                this.showNotification('üõ∞Ô∏è Accessing satellite positioning...', 'info');

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        latitudeInput.value = lat;
                        longitudeInput.value = lng;

                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                            const data = await response.json();
                            
                            if (data.display_name && locationInput) {
                                locationInput.value = data.display_name;
                                this.showNotification('üéØ Location pinpointed!', 'success');
                                this.createLocationPinEffect();
                            } else {
                                throw new Error('Could not get address');
                            }
                        } catch (error) {
                            if (locationInput) {
                                locationInput.value = `üìç Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                            }
                            this.showNotification('üó∫Ô∏è Location detected (approximate)', 'warning');
                        }
                    },
                    (error) => {
                        let message = '‚ùå Location detection failed';
                        if (error.code === error.PERMISSION_DENIED) {
                            message = 'üîí Location access denied. Please enable permissions.';
                        } else if (error.code === error.TIMEOUT) {
                            message = '‚è∞ Location scan timed out.';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            message = 'üì° Location unavailable.';
                        }
                        this.showNotification(message, 'error');
                    }
                ).finally(() => {
                    detectBtn.innerHTML = originalHTML;
                    detectBtn.disabled = false;
                    detectBtn.style.animation = '';
                });
            }

            createLocationPinEffect() {
                const locationInput = document.getElementById('location');
                if (locationInput) {
                    for (let i = 0; i < 15; i++) {
                        const pin = document.createElement('div');
                        pin.style.cssText = `
                            position: absolute;
                            width: 2px;
                            height: 10px;
                            background: #39FF14;
                            left: ${locationInput.getBoundingClientRect().left + Math.random() * locationInput.offsetWidth}px;
                            top: ${locationInput.getBoundingClientRect().top}px;
                            animation: locationPin 0.8s ease-out forwards;
                        `;
                        
                        document.body.appendChild(pin);
                        
                        setTimeout(() => {
                            pin.remove();
                        }, 800);
                    }
                }
            }

            async handleSubmit(event) {
                event.preventDefault();
                
                const form = event.target;
                const formData = new FormData(form);
                const submitBtn = document.getElementById('submitBtn');
                
                // Enhanced validation
                const requiredFields = form.querySelectorAll('[required]');
                let isValid = true;
                
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        field.style.borderColor = '#FF6B6B';
                        field.style.boxShadow = '0 0 30px #FF6B6B';
                        this.createFieldErrorEffect(field);
                        isValid = false;
                    }
                });

                if (!isValid) {
                    this.showNotification('‚ö†Ô∏è Please complete all required fields', 'warning');
                    return;
                }

                // Ultra-enhanced loading state
                const originalHTML = submitBtn.innerHTML;
                submitBtn.innerHTML = `
                    <div class="loading-spinner"></div>
                    <span>üöÄ Launching Your Complaint...</span>
                `;
                submitBtn.disabled = true;
                submitBtn.style.animation = 'gradientShift 0.5s ease infinite';

                // Create loading particles
                this.createLoadingParticles(submitBtn);

                // Simulate form submission
                setTimeout(() => {
                    this.showNotification('üéâ Complaint launched successfully! üöÄ', 'success');
                    
                    // Mega celebration effect
                    this.createUltraCelebration();
                    
                    setTimeout(() => {
                        // Reset form and button
                        form.reset();
                        submitBtn.innerHTML = originalHTML;
                        submitBtn.disabled = false;
                        submitBtn.style.animation = '';
                        
                        // Reset category selection
                        document.querySelectorAll('.category-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        
                        // Reset image preview
                        removeImagePreview();
                        
                        // Reset progress
                        this.updateProgress();
                    }, 3000);
                }, 2000);
            }

            createFieldErrorEffect(field) {
                const rect = field.getBoundingClientRect();
                for (let i = 0; i < 8; i++) {
                    const particle = document.createElement('div');
                    particle.style.cssText = `
                        position: fixed;
                        width: 4px;
                        height: 4px;
                        background: #FF6B6B;
                        border-radius: 50%;
                        pointer-events: none;
                        z-index: 1000;
                        left: ${rect.left + Math.random() * rect.width}px;
                        top: ${rect.top}px;
                        animation: fieldError 1s ease-out forwards;
                    `;
                    
                    document.body.appendChild(particle);
                    
                    setTimeout(() => {
                        particle.remove();
                    }, 1000);
                }
            }

            createLoadingParticles(element) {
                const rect = element.getBoundingClientRect();
                const interval = setInterval(() => {
                    for (let i = 0; i < 3; i++) {
                        const particle = document.createElement('div');
                        particle.style.cssText = `
                            position: fixed;
                            width: 4px;
                            height: 4px;
                            background: ${this.getRandomRainbowColor()};
                            border-radius: 50%;
                            left: ${rect.left + Math.random() * rect.width}px;
                            top: ${rect.top + rect.height}px;
                            animation: loadingParticle 1.5s ease-out forwards;
                            z-index: 1000;
                        `;
                        
                        document.body.appendChild(particle);
                        
                        setTimeout(() => {
                            particle.remove();
                        }, 1500);
                    }
                }, 200);

                // Store interval ID to clear later
                element.dataset.loadingInterval = interval;
                
                // Clear interval after 2 seconds
                setTimeout(() => {
                    clearInterval(interval);
                }, 2000);
            }

            createUltraCelebration() {
                // Create multiple types of celebration effects
                this.createConfettiStorm();
                this.createFireworks();
                this.createFloatingEmojis();
            }

            createConfettiStorm() {
                const colors = ['#FF6B6B', '#FFA500', '#FFD93D', '#6BCF7F', '#4D96FF', '#9D4EDD'];
                for (let i = 0; i < 200; i++) {
                    const confetti = document.createElement('div');
                    confetti.style.cssText = `
                        position: fixed;
                        width: ${Math.random() * 12 + 6}px;
                        height: ${Math.random() * 12 + 6}px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        top: -20px;
                        left: ${Math.random() * 100}vw;
                        border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                        animation: confettiFall ${Math.random() * 3 + 2}s linear forwards;
                        z-index: 10000;
                        transform: rotate(${Math.random() * 360}deg);
                    `;
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }
            }

            createFireworks() {
                for (let i = 0; i < 10; i++) {
                    setTimeout(() => {
                        this.createFirework(
                            Math.random() * window.innerWidth,
                            Math.random() * window.innerHeight / 2
                        );
                    }, i * 300);
                }
            }

            createFirework(x, y) {
                const colors = ['#FF6B6B', '#FFA500', '#FFD93D', '#6BCF7F', '#4D96FF', '#9D4EDD'];
                for (let i = 0; i < 60; i++) {
                    const particle = document.createElement('div');
                    particle.style.cssText = `
                        position: fixed;
                        width: 4px;
                        height: 4px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        border-radius: 50%;
                        left: ${x}px;
                        top: ${y}px;
                        animation: fireworkParticle 1.5s ease-out forwards;
                        z-index: 10000;
                    `;
                    
                    document.body.appendChild(particle);
                    
                    setTimeout(() => {
                        particle.remove();
                    }, 1500);
                }
            }

            createFloatingEmojis() {
                const emojis = ['üéâ', 'üöÄ', '‚≠ê', '‚ú®', 'üéä', 'üî•', 'üí´', 'üåü'];
                for (let i = 0; i < 20; i++) {
                    const emoji = document.createElement('div');
                    emoji.style.cssText = `
                        position: fixed;
                        font-size: ${Math.random() * 24 + 16}px;
                        top: 100vh;
                        left: ${Math.random() * 100}vw;
                        animation: emojiFloat ${Math.random() * 3 + 2}s ease-out forwards;
                        z-index: 10000;
                        pointer-events: none;
                    `;
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    
                    document.body.appendChild(emoji);
                    
                    setTimeout(() => {
                        emoji.remove();
                    }, 5000);
                }
            }

            showNotification(message, type = 'info') {
                // Remove existing notifications
                const existingNotifications = document.querySelectorAll('.notification');
                existingNotifications.forEach(notification => notification.remove());

                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${this.getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                `;

                document.body.appendChild(notification);

                // Enhanced auto-remove with fade-out
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.style.animation = 'notificationSlide 0.5s ease reverse forwards';
                        setTimeout(() => notification.remove(), 500);
                    }
                }, 5000);
            }

            getNotificationIcon(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            }
        }

        // Add additional CSS animations
        const additionalStyles = document.createElement('style');
        additionalStyles.textContent = `
            @keyframes trailFade {
                0% { opacity: 1; transform: scale(1); }
                100% { opacity: 0; transform: scale(0); }
            }
            
            @keyframes fieldSuccess {
                0% { transform: translate(0, 0) scale(1); opacity: 1; }
                100% { transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px) scale(0); opacity: 0; }
            }
            
            @keyframes fieldError {
                0% { transform: translate(0, 0) scale(1); opacity: 1; }
                100% { transform: translate(0, ${Math.random() * 50 + 20}px) scale(0); opacity: 0; }
            }
            
            @keyframes stepParticle {
                0% { transform: translate(0, 0) scale(1); opacity: 1; }
                100% { transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px) scale(0); opacity: 0; }
            }
            
            @keyframes sparkle {
                0% { transform: translate(0, 0) scale(1); opacity: 1; }
                100% { transform: translate(${Math.random() * 200 - 100}px, ${Math.random() * 200 - 100}px) scale(0); opacity: 0; }
            }
            
            @keyframes locationPin {
                0% { transform: translateY(0) scale(1); opacity: 1; }
                100% { transform: translateY(-100px) scale(0); opacity: 0; }
            }
            
            @keyframes loadingParticle {
                0% { transform: translateY(0) scale(1); opacity: 1; }
                100% { transform: translateY(-100px) scale(0); opacity: 0; }
            }
            
            @keyframes confettiFall {
                0% { transform: translateY(0) rotate(0deg); }
                100% { transform: translateY(100vh) rotate(${Math.random() * 720}deg); }
            }
            
            @keyframes fireworkParticle {
                0% { transform: translate(0, 0) scale(1); opacity: 1; }
                100% { transform: translate(${Math.random() * 200 - 100}px, ${Math.random() * 200 - 100}px) scale(0); opacity: 0; }
            }
            
            @keyframes emojiFloat {
                0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
            }
            
            @keyframes removalParticle {
                0% { transform: scale(1); opacity: 1; }
                100% { transform: scale(0); opacity: 0; }
            }
            
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
        `;
        document.head.appendChild(additionalStyles);

        // Initialize the ultra colorful complaint form
        document.addEventListener('DOMContentLoaded', () => {
            new UltraColorfulComplaintForm();

            /* Focus-fix: ensure inputs/selects/textareas reliably receive focus
               even if decorative layers or global listeners sometimes intercept
               pointer events. This adds tabindex, stops propagation on pointer
               down for form controls, and focuses the nearest control when a
               form group or card is clicked. */
            try {
                document.querySelectorAll('input, textarea, select').forEach(el => {
                    if (!el.hasAttribute('tabindex')) el.setAttribute('tabindex', '0');
                    el.addEventListener('pointerdown', (e) => { e.stopPropagation(); }, {capture: true});
                    el.addEventListener('mousedown', (e) => { e.stopPropagation(); }, {capture: true});
                });

                // Focus input when clicking non-interactive parts of a form group.
                // Do NOT capture or stop propagation so interactive children
                // (buttons, category tiles, file uploader, location button) still
                // receive their click events.
                document.querySelectorAll('.form-group').forEach(group => {
                    group.addEventListener('click', (e) => {
                        // If user clicked on an interactive element, skip focusing.
                        const interactive = e.target.closest('input, textarea, select, button, a, .category-option, .image-upload-container, .location-btn, .btn-submit');
                        if (interactive) return; // let the interactive element handle the event

                        const control = group.querySelector('input, textarea, select');
                        if (control) {
                            control.focus();
                        }
                    });
                });

                // Only focus the first control when the actual card background is
                // clicked (avoid stealing focus when clicking buttons, inputs,
                // category tiles, or other interactive elements).
                const card = document.querySelector('.form-card');
                if (card) {
                    card.addEventListener('click', (e) => {
                        // If the direct target is the card itself (i.e. blank area),
                        // focus the first input. Otherwise do nothing so interactive
                        // children behave normally.
                        if (e.target === card) {
                            const ctrl = card.querySelector('input, textarea, select');
                            if (ctrl) ctrl.focus();
                        }
                    }, {capture: true});
                }
            } catch (err) {
                console.warn('Focus-fix setup failed:', err);
            }
            // Temporary debug helper: click any place to highlight and log the
            // topmost element under the cursor. Useful to find invisible
            // overlays or elements intercepting clicks. Remove after debugging.
            (function installClickInspector(){
                if (!window.__clickInspectorInstalled) {
                    window.__clickInspectorInstalled = true;
                    document.addEventListener('click', function inspector(e){
                        const x = e.clientX, y = e.clientY;
                        const top = document.elementFromPoint(x, y);
                        console.log('Click inspector: elementFromPoint ->', top);

                        if (!top) return;

                        // Create highlight overlay
                        const box = document.createElement('div');
                        const rect = top.getBoundingClientRect();
                        box.style.position = 'fixed';
                        box.style.left = rect.left + 'px';
                        box.style.top = rect.top + 'px';
                        box.style.width = rect.width + 'px';
                        box.style.height = rect.height + 'px';
                        box.style.border = '3px solid rgba(255,0,0,0.9)';
                        box.style.zIndex = 9999999;
                        box.style.pointerEvents = 'none';
                        box.style.boxSizing = 'border-box';
                        document.body.appendChild(box);

                        // Create label
                        const label = document.createElement('div');
                        label.textContent = `${top.tagName.toLowerCase()}${top.id ? '#'+top.id : ''} ${top.className ? '.'+top.className.split(' ').join('.') : ''}`;
                        label.style.position = 'fixed';
                        label.style.left = rect.left + 'px';
                        label.style.top = (rect.top - 22) + 'px';
                        label.style.background = 'rgba(255,0,0,0.9)';
                        label.style.color = 'white';
                        label.style.padding = '2px 6px';
                        label.style.fontSize = '12px';
                        label.style.zIndex = 9999999;
                        label.style.pointerEvents = 'none';
                        document.body.appendChild(label);

                        setTimeout(()=>{ box.remove(); label.remove(); }, 2500);
                    }, true);
                }
            })();
        });
    </script>
</body>
</html>